<div id=D__ID>
	<!--third html start -->
	<div class="container mt-95">
		<!-- form container start -->
		<div class="formbox">
			<!-- form start -->
			<form id="F__ID">
				<span id=title__ID></span>
				<!-- form-design name and study id -->
				<div class="formgroup">
					<fieldset class="">
						<div class="grid-container-4">
							<div>
								<label><span class="question">Product Name</span>
									<input type=text name="Product_Name" id="Product_Name__ID" class="formcontrol threeqwidth" />
								</label>
							</div>
							<div>
								<label><span class="question">Products ID</span>
									<input type=text name="Product_uid" class="formcontrol threeqwidth" readonly />
								</label>
							</div>
							<div>
								<label><span class="question">Format</span>
									<input type=text name="Format" class="formcontrol threeqwidth" readonly />
								</label>
							</div>
							<div id="convers__ID" style="display:none">
								<div>
									<label><span class="question">Conversion</span>
										<p class="" id="conversion__ID"></p>
									</label>
								</div>
							</div>
						</div>
					</fieldset>
				</div>
				<div id="product_selection__ID">
					<div class="formgroup">
						<fieldset class="">
							<span class="question">
								Current Stock<span></span>
							</span>
							<div class="grid-container-4">
								<div>
									<label><span class="question">Front Storage</span>
										<input type=text name="Front_Storage" class="formcontrol threeqwidth" readonly />
									</label>
									<label><span class="question">Update Stock</span>
										<input type=text id="Front_Storage__ID" class="formcontrol threeqwidth" readonly />
									</label>
								</div>
								<div>
									<label><span class="question">Back Storage</span>
										<input type=text name="Back_Storage" class="formcontrol threeqwidth" readonly />
									</label>
									<label><span class="question">&nbsp;</span>
										<input type=text id="Back_Storage__ID" class="formcontrol threeqwidth" readonly />
									</label>
								</div>
								<div>
									<label><span class="question">Total</span>
										<input type=text name="Total_in_storage" class="formcontrol threeqwidth" readonly />
									</label>
									<label><span class="question">&nbsp;</span>
										<input type=text id="Total_in_storage__ID" class="formcontrol threeqwidth" readonly />
									</label>
								</div>
								<div>
									<label><span class="question">Current Batch</span>
										<input type=text name="Current_Batch" class="formcontrol threeqwidth" readonly />
									</label>
									<label><span class="question">&nbsp;</span>
										<input type=text id="Current_Batch__ID" class="formcontrol threeqwidth" readonly />
									</label>
								</div>
							</div>
						</fieldset>
					</div>
					<div class="formgroup">
						<div class="questiongroup ">
							<fieldset>
								<span class="question">
									Transaction type
								</span>
								<div class="grid-container-3">
									<div><input id="Transaction_type_2__ID" name="Transaction_type" type="radio"
											value="Put in">
										<label class="rd_btn width_btn_full textcenter" for="Transaction_type_2__ID">Put in</label>
									</div>
									<div>
										<input id="Transaction_type_1__ID" name="Transaction_type" type="radio"
											value="Take out">
										<label class="rd_btn width_btn_full textcenter" for="Transaction_type_1__ID">Take out</label>
									</div>
									<div><input id="Transaction_type_3__ID" name="Transaction_type" type="radio"
											value="Move">
										<label class="rd_btn width_btn_full textcenter" for="Transaction_type_3__ID">Move</label>
									</div>
									<!--<div><input id="Transaction_type_4__ID" name="Transaction_type" type="radio"
											value="Stocktake">
										<label class="rd_btn " for="Transaction_type_4__ID">Stocktake
											Adjustment</label>
									</div>-->
								</div>
							</fieldset>
						</div>
					</div>
					<div id="quantity_div__ID">
						<div class="formgroup">
							<div class="questiongroup ">
								<fieldset>
									<span class="question">
										Specify Quantity and Date
									</span>
									<div class="grid-container-3">
										<div>
											<label><span class="question" id="quantity_label__ID">Quantity</span>
												<input type="text" name="Quantity" id="Quantity__ID" class="formcontrol" />
											</label>
										</div>
										<div id="select_tbsp__ID">
											<label><span class="question" >Select # tsp</span>
												<select id="select_powder__ID" class="formcontrol" >
													<option value="0"></option>
													<option value="0.125">1/8 tsp</option>
													<option value="0.250">1/4 tsp</option>
													<option value="0.5">1/2 tsp</option>
													<option value="1">1 tsp</option>
													<option value="2">2 tsp</option>
													<option value="3">3 tsp</option>
												</select>
											</label>
										</div>
										<div>
											<label><span class="question">Date</span>
												<input type="date" name="Transaction_Date" class="formcontrol"  />
											</label>
										</div>
									</div>
								</fieldset>
							</div>
						</div>	
						<div id="Transaction_type_in__ID">
							<div class="formgroup">
								<div class="questiongroup ">
									<fieldset>
										<div class="grid-container-3">
											<div>
												<label><span class="question">Usage Type</span>
													<select name="Usage_Type" id="Usage_Type__ID" class="formcontrol">
														<option></option>
														<option>Expiry Date</option>
														<option>Best Before</option>
														<option>Manufacturing Date</option>
													</select>
												</label>
											</div>
											<div>
												<label><span class="question">Usage Date</span>
													<input type="date" name="Usage_Date" id="Usage_Date__ID" class="formcontrol"  />
												</label>
											</div>
											<div>
												<label><span class="question">Active Batch</span>
													<input type="text" name="Active_Batch" id="Active_Batch__ID" class="formcontrol" readonly />
												</label>
											</div>
										</div>
										
									</fieldset>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="formgroup right">
					<button type="submit" id="submit__ID" class="btn">Submit</button>
				</div>
			</form>
		</div>
	</div>
	<script>
		function F__ID() {
			//-------------------------------------
			VmInclude: '__HOST__/assets/js/form.01.js'
			//-------------------------------------
			var conversion=0;
			var load = m.load;
			m.load = function () {
				load();
				console.log(JSON.stringify(m.input.record))
				$('#F__ID input[name="Front_Storage"]').val("0");
				$('#F__ID input[name="Back_Storage"]').val("0");
				$('#F__ID input[name="Total_in_storage"]').val("0");
				$('#F__ID input[name="Current_Batch"]').val("0");
				$('#product_selection__ID').hide();
				if(m.input.record!=undefined){
					$('#F__ID input[name="Front_Storage"]').val("0");
					$('#F__ID input[name="Back_Storage"]').val("0");
					$('#F__ID input[name="Total_in_storage"]').val("0");
					$('#F__ID input[name="Current_Batch"]').val("0");
					$("#F__ID input[name=Product_uid]").val(m.input.record.UID);
					$("#F__ID input[name=Product_Name]").val(m.input.record.I2);
					$("#F__ID input[name=Format]").val(m.input.record.I3);

					conversion=parseFloat(m.input.record.Data.Tbsp_to_grams);
					if(m.input.record.I3=="Powder") {$("#F__ID #convers__ID").show();$("#F__ID #select_tbsp__ID").show();$("#F__ID #Quantity__ID").prop('readonly',true);}
					else {$("#F__ID #convers__ID").hide();$("#F__ID #select_tbsp__ID").hide();$("#F__ID #Quantity__ID").prop('readonly',false);};
					$("#F__ID #conversion__ID").text("1 tsp = "+m.input.record.Data.Tbsp_to_grams+" grams");
					get_last_transaction(m.input.record.UID);
					$('#product_selection__ID').show();
				}
				switch($("#F__ID input[name='Transaction_type']:checked").val()){
					case 'Move': 
						$('#quantity_label__ID').text("Quantity moved from BS to FS");
						$('#Transaction_type_in__ID').hide();
						//$('#F__ID input[name=Usage_Date]').val("");
						//$('#F__ID select[name=Usage_Type]').val("");
						break;
					case 'Take out':
						$('#quantity_label__ID').text("Quantity taken from Front Storage");
						$('#Transaction_type_in__ID').show();
						document.getElementById('Usage_Date__ID').readOnly=true;
						document.getElementById('Usage_Type__ID').disabled=true;
						break;
					case 'Put in':
						if($("#F__ID input[name=Format]").val()=='Powder') $('#quantity_label__ID').text("Quantity in grams put into Back Storage");
						else if($("#F__ID input[name=Format]").val()=='Fluid') $('#quantity_label__ID').text("Quantity in ml put into Back Storage");
						else if($("#F__ID input[name=Format]").val()=='Tablets') $('#quantity_label__ID').text("Quantity numbers of pills put into Back Storage");						
						$('#Transaction_type_in__ID').show();
						document.getElementById('Usage_Date__ID').readOnly=false;
						document.getElementById('Usage_Type__ID').disabled=false;
						break;
					/*case 'Stocktake':
						$('#quantity_label__ID').text("Set Quantity in Front Storage");
						$('#Transaction_type_in__ID').hide();
						break;*/
					default:
						$('#quantity_label__ID').text("Quantity");
						$('#Transaction_type_in__ID').hide();
						$('#quantity_div__ID').hide();
						break;
					}
			}
			//----------------------------------
			m.before_submit = function (data, index) {
				data.Total_in_storage=$('#Total_in_storage__ID').val();
				data.Front_Storage=$('#Front_Storage__ID').val();
				data.Back_Storage=$('#Back_Storage__ID').val();
				data.Current_Batch=$('#Current_Batch__ID').val();
				data.Usage_Type=$('#Usage_Type__ID').val();
				data.Usage_Date=$('#Usage_Date__ID').val();
				index.I1=parseInt(data.Product_uid)
				index.I3=data.Transaction_type;
				index.I4=parseFloat($('#Front_Storage__ID').val()).toFixed(0);
				index.I5=parseFloat($('#Back_Storage__ID').val()).toFixed(0);
				index.I6=parseFloat($('#Current_Batch__ID').val()).toFixed(0);
			}
			//-------------------------------------
			$("#F__ID #select_powder__ID").change(function () {
				$('#F__ID input[name="Quantity"]').val((conversion*parseFloat($('#select_powder__ID').val())).toFixed(0));
				update_stock();
			})
			//-------------------------------------
			$("input[name='Transaction_type']").change(function () {
				if($("#F__ID input[name=Format").val()=="Powder") {console.log("Format");$("#F__ID #convers__ID").show();$("#F__ID #select_tbsp__ID").show();$("#F__ID #Quantity__ID").prop('readonly',true);}
				else {console.log("Format hide");$("#F__ID #convers__ID").hide();$("#F__ID #select_tbsp__ID").hide();$("#F__ID #Quantity__ID").prop('readonly',false);}
				$("#F__ID #Quantity__ID").val("");
				$('#Back_Storage__ID').val("");
				$('#Front_Storage__ID').val("");
				$('#Total_in_storage__ID').val("")					
				$('#Current_Batch__ID').val("")
				switch($("#F__ID input[name='Transaction_type']:checked").val()){
            	case 'Move': 
					$('#quantity_label__ID').text("Quantity moved from BS to FS");
					$('#Transaction_type_in__ID').hide();
					$("#F__ID #select_tbsp__ID").hide();$("#F__ID #Quantity__ID").prop('readonly',false);
					$('#quantity_div__ID').show();						
					//$('#F__ID input[name=Usage_Date]').val("");
					//$('#F__ID select[name=Usage_Type]').val("");
					break;
				case 'Take out':
					$('#quantity_label__ID').text("Quantity taken from Front Storage");
					$('#Transaction_type_in__ID').show();
					//$("#F__ID #select_tbsp__ID").show();$("#F__ID #Quantity__ID").prop('readonly',true);
					document.getElementById('Usage_Date__ID').readOnly=true;
					document.getElementById('Usage_Type__ID').disabled=true;
					$('#quantity_div__ID').show();						
					break;
				case 'Put in':
					if($("#F__ID input[name=Format]").val()=='Powder') $('#quantity_label__ID').text("Quantity in grams put into Back Storage");
					else if($("#F__ID input[name=Format]").val()=='Fluid') $('#quantity_label__ID').text("Quantity in ml put into Back Storage");
					else if($("#F__ID input[name=Format]").val()=='Tablets') $('#quantity_label__ID').text("Quantity numbers of pills put into Back Storage");
					$("#F__ID #select_tbsp__ID").hide();$("#F__ID #Quantity__ID").prop('readonly',false);						
					$('#Transaction_type_in__ID').show();
					document.getElementById('Usage_Date__ID').readOnly=false;
					document.getElementById('Usage_Type__ID').disabled=false;
					$('#quantity_div__ID').show();	
					$("#F__ID input[name=Active_Batch]").val('Not Active');					
					break;
				/*case 'Stocktake':
					$('#quantity_label__ID').text("Set Quantity in Front Storage");
					$('#Transaction_type_in__ID').hide();
					$("#F__ID #select_tbsp__ID").hide();$("#F__ID #Quantity__ID").prop('readonly',false);						
					$('#quantity_div__ID').show();						
					break;*/
				default:
					$('#quantity_label__ID').text("Quantity");
					$('#Transaction_type_in__ID').hide();
					$('#quantity_div__ID').hide();						

					break;
				}
			})
			//-------------------------------------
			var update_stock=function(){
				console.log("QNTY")
				var bs=0;
				var fs=0;
				var nq=0;
				var cb=0;
				bs=parseFloat($('#F__ID input[name="Back_Storage"]').val());
				fs=parseFloat($('#F__ID input[name="Front_Storage"]').val());
				nq=parseFloat($('#F__ID input[name="Quantity"]').val());
				cb=parseFloat($('#F__ID input[name="Current_Batch"]').val());
				switch($("#F__ID input[name='Transaction_type']:checked").val()){
            	case 'Move': 
						if(bs-nq < 0) {
							$vm.alert("Not enough in Back Storage. Max = "+bs.toFixed(0))
							nq=bs;
							$('#F__ID input[name="Quantity"]').val(nq.toFixed(0));
						}
						$('#F__ID #Back_Storage__ID').val((bs-nq).toFixed(0));
						$('#F__ID #Front_Storage__ID').val((fs+nq).toFixed(0));
						$('#F__ID #Total_in_storage__ID').val((bs+fs).toFixed(0));					
						$('#F__ID #Current_Batch__ID').val((cb).toFixed(0));					
					break;
				case 'Take out':
					console.log("cur: "+cb+ " nq: "+nq)
						if(fs-nq < 0) {
							$vm.alert("Not enough in Front Storage. Max = "+fs.toFixed(0))
							nq=fs;
							$('#F__ID input[name="Quantity"]').val(nq.toFixed(0));
						}
						$('#F__ID #Back_Storage__ID').val((bs).toFixed(0));
						$('#F__ID #Front_Storage__ID').val((fs-nq).toFixed(0));
						$('#F__ID #Total_in_storage__ID').val((bs+fs-nq).toFixed(0))					
						$('#F__ID #Current_Batch__ID').val((cb-nq).toFixed(0));
						var cn=cb-nq;
						if(cb-nq<=0) {
							var prod_id= $('#F__ID input[name="Product_uid"]').val();
							set_active_batch(prod_id,cn);
						}				
					break;
				case 'Put in':
						$('#F__ID #Back_Storage__ID').val((nq+bs).toFixed(0));
						$('#F__ID #Front_Storage__ID').val(fs.toFixed(0));
						$('#F__ID #Total_in_storage__ID').val((bs+fs+nq).toFixed(0))
						$('#F__ID #Current_Batch__ID').val((cb).toFixed(0));
						if(bs+fs==0) {
							$("#F__ID input[name=Active_Batch]").val('Active');
							$('#F__ID #Current_Batch__ID').val((nq).toFixed(0));
						}
					break;
				/*case 'Stocktake':
						$('#Back_Storage__ID').val((bs).toFixed(0));
						$('#Front_Storage__ID').val((nq).toFixed(0));
						$('#Total_in_storage__ID').val((bs+nq).toFixed(0))					
						//$('#Current_Batch__ID').val((cb).toFixed(0));					
					break;*/
				default:
					break;
				}

			}
			//-------------------------------------
			$("input[name='Quantity']").change(function () {
				update_stock();
			})
			//-------------------------------------
			var set_active_batch=function(product_uid,cn){
				//jQuery.ajaxSetup({ async: false });
				console.log("set_active_batch")
				var query={$and:[{I1:parseInt(product_uid)},{I3: { "$eq":"Put in"}},{"Data.Active_Batch": { "$eq": "Not Active"}}] }
                    $vm.request({ cmd:'find',table:m.Table,query:query}, function (res) {
                        if (res.sys.permission == false) {
                            $vm.alert("No permission. Private database table, ask the table's owner for permissions.");
                            return;
                        }        
                        if (res.result.length > 0) {
							console.log("get result")
							$('#F__ID input[name="Current_Batch"]').val(res.result[res.result.length-1].Data.Quantity);
							$('#F__ID #Current_Batch__ID').val((parseFloat(res.result[res.result.length-1].Data.Quantity)-cn).toFixed(0));
							$('#F__ID #Usage_Type__ID').val(res.result[res.result.length-1].Data.Usage_Type);
							$('#F__ID input[name="Usage_Date"]').val(res.result[res.result.length-1].Data.Usage_Date);

/*							// Save data here, and do the update after submit.
							var rid=res.result[res.result.length-1]._id
							//$('#F__ID input[name="Active_Batch"]').val("Active");
							var all_data=res.result[res.result.length-1].Data;
							all_data.Active_Batch="Active";
							$vm.request({ cmd:'update',id:rid,table:m.Table,data:all_data}, function (res) {
								if(res.status=="np"){
                        			alert("No permission to update this record.");
                        		return;
                    			}
							})
*/							
                        }
						else{
							console.log("Nothing in db")
						}
                    })
                  //jQuery.ajaxSetup({ async: true });                
			}
			//-------------------------------------
			var get_active_batch=function(product_uid){
				//jQuery.ajaxSetup({ async: false });
				var query={$and:[{I1:parseInt(product_uid)},{I3: { "$eq":"Put in"}},{"Data.Active_Batch": { "$eq": "Active"}}] }
                    $vm.request({ cmd:'find',table:m.Table,query:query,limit:1}, function (res) {
                        if (res.sys.permission == false) {
                            $vm.alert("No permission. Private database table, ask the table's owner for permissions.");
                            return;
                        }        
                        if (res.result.length > 0) {
							$('#F__ID #Usage_Type__ID').val(res.result[0].Data.Usage_Type);
							$('#F__ID input[name="Usage_Date"]').val(res.result[0].Data.Usage_Date);
                        }
						else{
							console.log("Nothing in db")
						}
                    })
                  //jQuery.ajaxSetup({ async: true });                
			}
			//-------------------------------------
			var get_last_transaction=function(product_uid){
				//jQuery.ajaxSetup({ async: false });
				var query={I1:parseInt(product_uid)}
                    $vm.request({ cmd:'find',table:m.Table,query:query,limit:1}, function (res) {
                        if (res.sys.permission == false) {
                            $vm.alert("No permission. Private database table, ask the table's owner for permissions.");
                            return;
                        }        
                        if (res.result.length > 0) {
							$('#F__ID input[name="Front_Storage"]').val(res.result[0].I4.toString());
							$('#F__ID input[name="Back_Storage"]').val(res.result[0].I5.toString());
							if(res.result[0].I6!=undefined && res.result[0].I6!="" ){
								$('#F__ID input[name="Current_Batch"]').val(res.result[0].I6.toString());
							} 
							$('#F__ID input[name="Total_in_storage"]').val(res.result[0].Data.Total_in_storage)
							//$("#F__ID input[name=Usage_Type]").val(m.input.record.Data.Usage_Type);
							//$("#F__ID input[name=Usage_Date]").val(m.input.record.Data.Usage_Date);

                        }
						else{
							console.log("Nothing in db")
							$('#F__ID input[name="Front_Storage"]').val("0");
							$('#F__ID input[name="Back_Storage"]').val("0");
							$('#F__ID input[name="Total_in_storage"]').val("0");
							$('#F__ID input[name="Current_Batch"]').val("0");
						}
                    })
                  //jQuery.ajaxSetup({ async: true }); 
				  get_active_batch(product_uid)               
			}
			//-------------------------------------
			//auto select client
			var get_name = function (record) {
				var name = record.Data.Product_Name;
				return name;
			}
			var get_client_info = function (record) {
				var name = record.Data.Product_Name
				return name;
			}
			var autocomplete_req_1 = { cmd: "find", field: ".I2", table: m.client_table, options: {}, skip: 0, limit: 10 }
			var autocomplete_callback_1 = function (items) {
				$('#F__ID input[name="Front_Storage"]').val("0");
				$('#F__ID input[name="Back_Storage"]').val("0");
				$('#F__ID input[name="Total_in_storage"]').val("0");
				$('#F__ID input[name="Current_Batch"]').val("0");
				$("#F__ID input[name=Product_uid]").val(items["UID"]);
				$("#F__ID input[name=Product_Name]").val(get_client_info(items.record));
				$("#F__ID input[name=Format]").val(items.record.I3);
				$("#F__ID #conversion__ID").text("1 tsp = "+items.record.Data.Tbsp_to_gram+" grams");
				conversion=parseFloat(items.record.Data.Tbsp_to_gram);
				if(items.record.I3=="Powder") {$("#F__ID #convers__ID").show();$("#F__ID #select_tbsp__ID").show();$("#F__ID #Quantity__ID").prop('readonly',true);}
				else {$("#F__ID #convers__ID").hide();$("#F__ID #select_tbsp__ID").hide();$("#F__ID #Quantity__ID").prop('readonly',false);}
				get_last_transaction(items["UID"]);
				$('#product_selection__ID').show();
				console.log(JSON.stringify(items.record));
			}
			var autocomplete_list_1 = function (records) {
				var items = [];
				for (var i = 0; i < records.length; i++) {
					var obj = {};
					obj.label = get_name(records[i]);
					obj['UID'] = records[i].UID;
					obj['record'] = records[i];
					items.push(obj);
				}
				return items;
			}
			var wait1 = function () {
				$vm.autocomplete($('#Product_Name__ID'), autocomplete_req_1, autocomplete_list_1, autocomplete_callback_1);
			}
			var I = 0; var loop_1 = setInterval(function () {
				if ($vm['jquery-ui-min-js'] != undefined) { clearInterval(loop_1); wait1(); }
				I++; if (I > 50) { clearInterval(loop_1); alert("jquery-ui.min.js is not installed."); }
			}, 100);

			//-------------------------------------

		}
	</script>
	<style>
		/*VmInclude:__HOST__/assets/css/wapp-form.css*/
	</style>
</div>