<div id=D__ID>
    <!--third html start -->
    <div class="container mt-95">
        <!-- form container start -->
        <div class="formbox">
            <!-- form start -->
            <form id="F__ID">
                <span id=title__ID></span>
                <!-- participant name and study id -->
                <div class="formgroup">
                    <fieldset class="">
                        <div class=grid-container-1>
                                <textarea name="scanned_input" id="scanned_input__ID" style="width:98%; min-height: 400px;" class="formgroup"></textarea>
                        </div>
                    </fieldset>
                </div>
                <div class="formgroup right">
					<button type="submit" id="submit__ID" class="btn">Submit</button>
				</div>
            </form>
        </div>

    </div>
    VmInclude:__COMPONENT__/m/model.01.html
    <script>
        function F__ID() {
            //-------------------------------------
            VmInclude: '__HOST__/assets/js/form.01.js'
            //-------------------------------------
            var ex_fields="UID,Formula_Name,First_Name";
            var item_fields="Product,P_ID,Format,Tsp_to_grams,Quantity"
			var load = m.load;
			m.load = function () {
				load();	
                document.getElementById("scanned_input__ID").focus();

            }
            //-------------------------------------
            m.before_submit = function (data, index) {
			}
            //-------------------------------------
            m.after_insert = function (data,res){
                check_formula_input(data);
                $vm.load_module('home');
            }
            //-------------------------------------
            m.after_update = function (data,res){
                check_formula_input(data);
                $vm.load_module('home');
            }
            //-------------------------------------
            var check_formula_input=function(data){
                console.log("after insert or update")
                var input_data=data.scanned_input.split("\n")
                console.log(JSON.stringify(input_data))
                var start_line=0; var end_line=0;
                for (var j=0;j<input_data.length;j++){
                    input_data[j]=input_data[j].replace('\r','');
                    if(input_data[j]=="START") start_line=j;
                    if(input_data[j]=="END") end_line=j;
                    //console.log(start_line+' - '+end_line)
                    
                }
                var formula=[];
                for(var i=start_line+1;i<end_line;i++){
                    //console.log(input_data[i])
                    formula.push(JSON.parse(input_data[i]));
                }
                for(var i=0;i<formula.length;i++){
                    if(formula[i].qty!=undefined) {
                            if(formula[i].qty.select_powder!=undefined){
                                //console.log(formula[i-1].ingredient.Tsp_to_grams*formula[i].qty.select_powder) 
                                formula[i-1].ingredient.Quantity=(formula[i-1].ingredient.Tsp_to_grams*formula[i].qty.select_powder).toFixed(0);
                            }
                            else{
                                formula[i-1].ingredient.Quantity=formula[i].qty.Quantity;
                            }
                    }
                }
                var items_a={};
                var data={};
                var index={};
                var temp=[];
                //data.push(items_a);
                //console.log(JSON.stringify(data.items_a))
                for(var i=0;i<formula.length;i++){
                    if(formula[i].ingredient!=undefined){
                        temp.push(formula[i].ingredient);
                    }
                    else if(formula[i].people!=undefined){
                        data=formula[i].people;
                    }
                }
                //data.items_a={};
                data.Input_type="Scanned"
                data.items_a=temp;
				var prod=[];
				for (var i=0;i<data.items_a.length;i++){
					prod.push(parseInt(data.items_a[i].P_ID))
				}
				prod.sort(function(a, b) {return a - b;});
				//console.log(JSON.stringify(prod))
				index.I2=JSON.stringify(prod);
                $vm.request({cmd:'insert',table:'demo-formula-comeback',data:data,index:index},function(res){
                    if(res.status=="np"){
                        alert("No permission to insert a new record in to the database.");
                        if(m.input!=undefined && m.input.goback!=undefined){
                            $vm.load_module('home');
                        }
                        return;
                    }
                });
            }
        }
    </script>
    <style>
        /*VmInclude:__HOST__/assets/css/wapp-form.css*/
    </style>
</div>