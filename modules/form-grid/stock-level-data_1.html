<div id=D__ID>
    <div>
            <!--VmInclude:__HOST__/assets/html/grid.01.stock.html-->
        </div>
    <script>
        function F__ID(){
            //-------------------------------------
            VmInclude:'__HOST__/assets/js/grid.01.js'
            //-------------------------------------
            $('#title__ID').text($vm.module_list[$vm.vm['__ID'].name].task_name);            
            //-------------------------------------
            var fields="_System_ID,Product_Name,Size,Supplier,Location_FS,Location_BS,Stock_level,Warning_Level";
            m.fields=""+fields+",Submit_date,Submitted_by,_Delete";
            //-------------------------------------
            var tb1=$vm.module_list['stock-level-data'].Table;
            var tb2=$vm.module_list['stock-level-data'].Table2;
            //-------------------------------------
            var table_check=[];
            var all_data=[];
            var bi_txt=[];
            var tb=[];
            var N;
            tb.push(tb1);
            tb.push(tb2);
            //-------------------------------------
            m.load=function(){
                for (var i=0;i<tb.length;i++){
                    N=i+1;
                    check_local_storage(tb[i],N)
                }
            }
            //-------------------------------------
            m.data_process=function(res){
            }
            //-------------------------------------
            m.cell_render=function(records,I,field,td,set_value,source){
            }
            //--------------------------------------------------------
            var check_local_storage=function(tb,N){
                var submit_t
                var update_t
                var count_t
                var tb_list={"table":{"name":undefined,"count":undefined,"submit":undefined,"update":undefined,"order":undefined}};
                //check if something is in local storage.
                if(tb!=undefined){
                    //jQuery.ajaxSetup({async:false});
                    //console.log($a.attr('href')+" - "+N+" - "+tb);
                    //Check if changes have been made since last download
                    setTimeout(function(){
                        tb_list.table.name=tb;
                        //Number of records
                        get_count(tb,tb_list);
                        //Latest submit time
                        get_submit_date(tb,tb_list);
                        //Latest update time
                        get_update_date(tb,tb_list);
                        /**/
                    }, N*1000);
                    //jQuery.ajaxSetup({async:true});
                }
            }
            //--------------------------------------------------------
            var get_submit_date=function(tb,tb_list){
                var b=Date.parse('01 Jan 2000');
                $vm.request({cmd:'find',table:tb,sort:{"Submit_date":-1},skip:0,limit:1},function(res){
                    if(res.status=='np'){
                        $vm.alert("No access permissions")
                    }
                    if(res.result.length==1){
                        //console.log("Submit_date: "+JSON.stringify(res.result[0].Submit_date))
                        tb_list.table.submit=res.result[0].Submit_date;
                    }
                    else{
                        tb_list.table.submit="";
                    }
                    console.log("update: "+tb_list.table.update+" - submit: "+tb_list.table.submit+" - count: "+tb_list.table.count )
                    if(tb_list.table.update!=undefined && tb_list.table.count!=undefined) {
                        //NN++
                        table_check.push(tb_list)
                        check_export(tb,tb_list)
                    }
                    //console.log(JSON.stringify(table_check)+"- "+NN)
                });
            }
            //--------------------------------------------------------			
            var get_update_date=function(tb,tb_list){
                var b=Date.parse('01 Jan 2000');
                $vm.request({cmd:'find',table:tb,sort:{"Update_date":-1},skip:0,limit:1},function(res){
                    if(res.status=='np'){
                        $vm.alert("No access permissions")
                    }
                    if(res.result.length==1){
                        //console.log("Update_date: "+JSON.stringify(res.result[0].Update_date))
                        if(res.result[0].Update_date!=undefined){
                            tb_list.table.update=res.result[0].Update_date;
                        }
                        else{
                            tb_list.table.update="";	
                        }
                    }
                    else{
                        tb_list.table.update="";
                    }	
                    console.log("update: "+tb_list.table.update+" - submit: "+tb_list.table.submit+" - count: "+tb_list.table.count )
                    if(tb_list.table.submit!=undefined && tb_list.table.count!=undefined){
                        //NN++
                        table_check.push(tb_list)
                        check_export(tb,tb_list)
                    }
                    //console.log(JSON.stringify(table_check)+"- "+NN)
                });
            }
            //--------------------------------------------------------			
            var get_count=function(tb,tb_list){
                var b=0;
                $vm.request({cmd:'count',table:tb},function(res){
                    if(res.status=='np'){
                        $vm.alert("No access permissions")
                    }
                    console.log(res.result)
                    if(res.result!=undefined){
                        //console.log("Update_date: "+JSON.stringify(res.result[0].Update_date))
                        tb_list.table.count=res.result;
                    }
                    console.log("update: "+tb_list.table.update+" - submit: "+tb_list.table.submit+" - count: "+tb_list.table.count )
                    if(tb_list.table.submit!=undefined && tb_list.table.update!=undefined) {
                        //NN++
                        table_check.push(tb_list)
                        check_export(tb,tb_list)
                    }
                });
            }
            //--------------------------------------------------------
            var check_export=function(tb,tb_list){
                if(tb_list.table.submit<tb_list.table.update) tb_list.table.submit=tb_list.table.update
                //Last number count
                var count=localStorage.getItem("export."+tb+".count");
                //Last storage time
                var storetime=localStorage.getItem("export."+tb+".storageTime");
                var sub_time=new Date(tb_list.table.submit);
                var store_time=new Date(storetime);
                if(count!=undefined && count==tb_list.table.count){
                    if(store_time>sub_time){
                        if(localStorage.getItem("export."+tb+".data")==undefined){
                            //Export records
                            move_to_local_storage(tb,true,tb_list.table.count)
                        }
                        else{
                            //Read from memory
                            move_to_local_storage(tb,false,tb_list.table.count)
                        }
                    }
                    else{
                        //Export records
                        move_to_local_storage(tb,true,tb_list.table.count)
                    }
                }
                else{
                        //Export records
                        move_to_local_storage(tb,true,tb_list.table.count)
                }
            }
            //--------------------------------------------------------
            var move_to_local_storage=function(tb,exp,count){
                console.log("table: "+tb+ " - "+exp)
                if(tb!=undefined){
                    if(exp){
                        //Export and store in local memory
                        var req={cmd:"export",table:tb,query:""}
                        open_model__ID();
                        $vm.request(req,function(N,i,txt){
                            //console.log(i+"/"+N);
                            $('#msg__ID').text((100*i/N).toFixed(0)+"%");
                            console.log((100*i/N).toFixed(0)+"%")                         
                            console.log("TXT length: "+txt.length)
                            if(i==-1){
                                var len=txt.length;
                                console.log("Data:"+txt);
                                var n_txt="["+txt.substring(5,len-9)+"]";
                                localStorage.setItem("export."+tb+".data",n_txt);
                                var d = new Date();
                                var now=d.toISOString();
                                localStorage.setItem("export."+tb+".storageTime",now);
                                localStorage.setItem("export."+tb+".count",count);
                                add_records(tb);
                            }
                        });
                        close_model__ID();
                    }
                    else{
                        add_records(tb);
                    }
                }
                else{console.log("ERRRRRRRRRRRRRRRRRRRROR")}
            }
            //--------------------------------------------------------
            var add_records=function(tb){
                for (var i=0;i<table_check.length;i++){
                    if(table_check[i].table.name==tb){
                        table_check[i].table.order=NN
                        break;
                    }
                }
                NN++
                var o=JSON.parse(localStorage.getItem("export."+tb+".data"));
                all_data.push(o)
                console.log("NN: "+NN+" bi.length: "+bi_txt.length)
                if(NN==bi_txt.length){
                    console.log("Prepare: "+JSON.stringify(all_data))
                    console.log("Table check: "+JSON.stringify(table_check))
                    console.log("Bi_txt: "+JSON.stringify(bi_txt))
                    prepare_output(all_data);
                }						
            }
            //--------------------------------------------------------
            var prepare_output=function(data){            

            }


    }
    </script>
    <style>
        /*VmInclude:__HOST__/assets/css/grid.css*/
        /*VmInclude:__HOST__/assets/css/wapp-form.css*/
    </style>
</div>
